---
import Header from '../components/molecules/Header.svelte';
import Footer from '../components/molecules/Footer.svelte';
import WhiteBackground from '../components/atoms/WhiteBackground.svelte';
import Container from '../components/atoms/Container.svelte';
import WorkImage from '../components/atoms/WorkImage.svelte';
import ListH1 from '../components/atoms/ListH1.svelte';
import WorkPrimaryImages from '../components/atoms/WorkPrimaryImages.svelte';
import WorkPrimaryImage from '../components/atoms/WorkPrimaryImage.svelte';
import WorkMain from '../components/atoms/WorkMain.svelte';
import Quote from '../components/molecules/Quote.svelte';
import List from '../components/molecules/List.svelte';
import MoreWork from '../components/atoms/MoreWork.svelte';
import ScreenTransition from '../components/atoms/ScreenTransition.svelte';

import fetchData from '../helpers/fetchData';
import siteQuery from '../queries/site';
import query from '../queries/works';
import nextWorkQuery from '../queries/nextWork';
import firstWorkQuery from '../queries/firstWork';

const { collection } = Astro.props;

const siteData = await fetchData(fetch, siteQuery);
const { headers, footers } = siteData;
let { menu } = siteData;

menu = menu.sort((a, b) => a.order - b.order);

const header = headers[0];
const footer = footers[0];

const work = collection.data.[0];
const { works, quote, quoter } = collection.data.[0];

const nextWork = work.id && await fetchData(fetch, nextWorkQuery, { id: work.id });
let nextData = nextWork?.worksConnection.edges[0];
let next;

if (!!nextData) {
    next = nextData && nextData.node;
} else {
    nextData = await fetchData(fetch, firstWorkQuery);
    next = nextData.works[0];
}

export async function createCollection() {
    let {works = [], worksPages = []} = await fetchData(fetch, query);

    works = works.map((work, index) => {
        work.oddEven = index % 2;
        return work;
    });

    let quote = worksPages[0]?.quote || '';
    let quoter = worksPages[0]?.quoter || '';

    return {
        routes: (works || []).map(work => ({ slug: work.slug })),
        permalink: ({ params }) => `/work/${params.slug}`,
        async data({ params }) {
            if (!params.slug) {
                return {
                    works,
                    quote,
                    quoter
                }
            }
            return {
                ...(works || []).find(work => work.slug === params.slug),
            }
        },
        pageSize: Infinity,
    };
}
---
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{work?.title || "Work"} - Abell Design</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville&display=swap" rel="stylesheet"> 
    <link rel="stylesheet" href="/style/global.css">
</head>
<body>
    <WhiteBackground>
        <Header client:load {header} {menu} />

        <Container>
            {work.title && (
                <div itemscope itemtype="https://schema.org/Service">
                    <ListH1 itemprop="name">{work.title}</ListH1>
                    <WorkPrimaryImages>
                        {(work.images || []).map(image => (
                            <WorkPrimaryImage>
                                <img src={image.url} alt='' itemprop="image" />
                            </WorkPrimaryImage>
                        ))}
                    </WorkPrimaryImages>

                    <WorkMain>
                        <p class="subtitle">{work.subtitle}</p>
                        <div class="markdown">
                            {work?.content?.html}
                        </div>
                        {work?.quote?.length > 0 && (
                            <Quote quote={work.quote} quoter={work.quoteAuthor} />
                        )}
                        <WorkPrimaryImages>
                        {(work.secondaryImages || []).map(image => (
                            <WorkPrimaryImage>
                                <img src={image.url} alt='' />
                            </WorkPrimaryImage>
                        ))}
                        </WorkPrimaryImages>
                        <MoreWork {next} />
                    </WorkMain>
                </div>
            )}

            {works && (
                <>
                    <List title="Work" data={works || []} headerType="h1" slugPrefix="/work" />

                    <Quote quote={quote} quoter={quoter} />
                </>
            )}
        </Container>
    </WhiteBackground>

    <Footer footer={footer} />
    <ScreenTransition />

    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-102804990-2', 'auto');
        ga('send', 'pageview');
    </script>
</body>
</html>
